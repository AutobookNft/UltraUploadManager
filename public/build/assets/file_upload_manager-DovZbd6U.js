import{S as x}from"./sweetalert2.esm.all-B0Dix5B2.js";const f=document.getElementById("status-message"),U=document.getElementById("status"),$=document.getElementById("scan-progress-text"),y=document.getElementById("progress-bar"),b=document.getElementById("progress-text"),H=document.getElementById("file-label"),L=document.getElementById("returnToCollection"),h=document.getElementById("scanvirus_label"),F=document.getElementById("scanvirus"),M=document.getElementById("virus-advise");document.getElementById("circle-loader");document.getElementById("circle-container");const w=document.getElementById("uploadBtn"),g=document.getElementById("cancelUpload"),X=document.querySelectorAll(".emoji"),R=document.querySelector('meta[name="csrf-token"]');if(!R)throw new Error("Meta tag with csrf-token not found");const T=R.getAttribute("content"),q=document.getElementById("collection");function k(){return document.getElementById("files")?document.getElementById("files").files:null}async function J(e){window.envMode==="local"&&console.log("Inside saveLocalTempFile");try{const o=await fetch("/upload-temp",{method:"POST",headers:{"X-CSRF-TOKEN":T,Accept:"application/json"},body:e});if(window.envMode==="local"&&console.log("Inside saveLocalTempFile. Response:",o),!o.ok){const n=await o.json();window.envMode==="local"&&console.log("Inside saveLocalTempFile. Result:",n);const t=JSON.stringify(n.error);throw window.envMode==="local"&&console.log("Inside saveLocalTempFile. Error:",t),new Error(t)}return o}catch(o){throw window.envMode==="local"&&console.error("Error in saveLocalTempFile:",o),o}}async function W(e){window.envMode==="local"&&console.log("Inside deleteTemporaryFileLocal",e);const o=new FormData;o.append("file",e),o.append("_token",T);try{const n=await fetch("/delete-temporary-file-local",{method:"POST",headers:{"X-CSRF-TOKEN":T,Accept:"application/json"},body:o});if(window.envMode==="local"&&(console.info("response:",n),console.info("response.status:",n.status)),!n.ok){const t=await n.json();throw window.envMode==="local"&&console.log("Inside deleteTemporaryFileLocal. Result:",t),t}return n}catch(n){throw window.envMode==="local"&&console.error("Error in deleteTemporaryFileLocal:",n),n}}const u=k()||[];function N(){for(let e=0;e<u.length;e++){const o=document.getElementById(`button-${u[e].name}`);o&&(o.style.display="none")}H.style.display="none",w.style.display="none",L.style.display="none",g.style.display="none"}function Q(){for(let e=0;e<u.length;e++){const o=document.getElementById(`button-${u[e].name}`);o&&(o.style.display="inline-block")}g.classList.remove("opacity-50","cursor-not-allowed"),w.style.display="inline-block",L.style.display="inline-block",g.style.display="inline-block",w.disabled=!1,w.classList.remove("opacity-50","cursor-not-allowed"),g.disabled=!1}function S(){for(let e=0;e<u.length;e++){const o=document.getElementById(`button-${u[e].name}`);o&&(o.style.display="inline-block")}H.style.display="inline-block",w.style.display="inline-block",w.classList.add("opacity-50","cursor-not-allowed"),w.disabled=!0,g.style.display="inline-block",g.disabled=!0,g.classList.add("opacity-50","cursor-not-allowed"),L.style.display="inline-block",_()}function _(){X.forEach(e=>{e.remove()})}function z(e,o,n){const t=document.createElement("div");t.classList.add("relative","group"),t.index=e,t.innerHTML=`
        <div class="relative group" id="file-${n[e].name}">
        <img src="${o.target.result}" alt="File Image" class="w-full h-40 object-cover rounded-lg shadow-md transition-all duration-300 group-hover:scale-105 z-0">
        <button type="button" id="button-${n[e].name}" onclick="removeFile('${n[e].name}')" class="bg-red-500 text-white absolute bottom-4 px-4 rounded-full text-sm hover:bg-red-700 z-10 hidden">
            ${window.btnDel}
        </button>
        <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-lg">
            <p class="text-white text-sm">File ${n[e].name}</p>
        </div>
    </div>`,q.appendChild(t),window.envMode==="local"&&console.log("File added:",n[e].name)}function v(e,o="info"){let n="",t="";switch(o){case"error":n="text-red-700",t="bg-red-200";break;case"success":n="text-green-700",t="bg-green-200";break;case"info":n="text-blue-700",t="bg-blue-200";break;case"warning":n="text-yellow-700",t="bg-yellow-200";break;default:n="text-blue-700",t="bg-blue-200"}e.includes("nn")||(U.innerHTML+=`
            <p class="font-bold ${n} ${t} px-4 py-2 rounded-lg shadow-md">
                ${e}
            </p>`)}function c(e,o="info"){let n;switch(o){case"error":n="text-red-700";break;case"success":n="text-white";break;case"warning":n="text-yellow-700";break;case"info":n="text-white";break;default:n="text-blue-700"}e.includes("nn")||(f.innerText=e,f.className=`font-bold ${n}`)}function Y(e){if(typeof e!="string"){console.error("fileNameInfected deve essere una stringa");return}const o=document.getElementById(`file-${e}`);if(o){const n=o.querySelector("img");n instanceof HTMLImageElement?n.style.border="3px solid red":console.error("Elemento immagine non trovato")}else console.error(`Immagine non trovata per il file: ${e}`)}async function Z(e){if(e)try{const o=Array.from(u).findIndex(n=>n.name===e);o!==-1&&(Array.from(u).splice(o,1),window.envMode==="local"&&console.log("file rimanenti:",u)),D(e),window.envMode==="local"&&console.log("file presenti DOPO della rimozione:",u)}catch(o){throw window.envMode==="local"&&console.error("Error deleting temporary file:",o),new Error(window.deleteFileError)}else window.envMode==="local"&&(console.log("File:",e),console.log("File index not removed:",e),console.log("File name not removed:",e))}function D(e){const o=document.getElementById(`file-${e}`);window.envMode==="local"&&console.log("file rimosso:",`file-${e}`),o&&o.parentNode&&(o.parentNode.removeChild(o),u.length===0&&S())}async function ee(e){window.envMode==="local"&&console.log("Inside scanFileWithProgress");let o=0;const n=35e3,t=Date.now();function l(){const a=Date.now()-t;o=Math.min(95,a/n*100),y.style.width=`${o}%`,b.innerText=`${Math.round(o)}%`,o>=95&&clearInterval(s)}const s=setInterval(l,100);window.envMode==="local"&&console.log("In scanFileWithProgress: formData:",e);try{const a=await fetch("/scan-virus",{method:"POST",headers:{"X-CSRF-TOKEN":T,Accept:"application/json"},body:e});if(clearInterval(s),a.ok){const r=setInterval(()=>{o+=.5,y.style.width=`${o}%`,b.innerText=`${Math.round(o)}%`,o>=100&&clearInterval(r)},50),d=await a.json();if(d)return{response:a,data:d};throw new Error("The JSON response is incorrect")}else{const r=await a.json();return{response:a,data:r}}}catch(a){throw clearInterval(s),a}}async function oe(e){await J(e);const{response:o,data:n}=await ee(e);if(await W(e.get("file")),window.envMode==="local"&&(console.log(`response: ${o}`),console.log(`data: ${JSON.stringify(n)}`)),!o.ok){if(o.status===422)return v(n.userMessage,"error"),!0;throw n}return!1}async function I(e){const o=document.createElement("div"),n=document.getElementById("status");o.classList.add("relative","group");let t="",l="",s="",a="";if(e==="success")s=window.emogyHappy,a="OK",t="https://cdn.nftflorence.com/assets/images/icons/GirlHappy.png",l="https://frangettediskspace.fra1.digitaloceanspaces.com/assets/images/icons/GirlHappy.png";else if(e==="someError")s=window.emogySad,a=window.someError,t="https://cdn.nftflorence.com/assets/images/icons/GirlDisp.png",l="https://frangettediskspace.fra1.digitaloceanspaces.com/assets/images/icons/GirlDisp.png";else if(e==="completeFailure")s=window.emogyAngry,a=window.completeFailure,t="https://cdn.nftflorence.com/assets/images/icons/GirlSad.png",l="https://frangettediskspace.fra1.digitaloceanspaces.com/assets/images/icons/GirlSad.png";else throw new Error("Tipo non valido");const r=window.setTimeout(()=>{o.innerHTML=`
            <div class="flex items-center justify-center mt-4">
                <span class="font-bold text-4xl">${a}</span>
            </div>
        `,n.appendChild(o)},3e3);try{(await fetch(t,{method:"HEAD"})).ok||(t=l)}catch{t=l}o.innerHTML=`
        <div class="flex items-center justify-center mt-4">
            <img src="${t}"
            alt="${s}"
            id="emojy"
            title="${s}"
            class="w-40 h-40 object-cover rounded-full shadow-md transition-all duration-300 group-hover:scale-105 z-0">
        </div>
    `,n.appendChild(o),clearTimeout(r)}class B{constructor(){const o=document.querySelector('meta[name="csrf-token"]');if(!o)throw new Error("CSRF token non trovato nel DOM");this.csrfToken=o.getAttribute("content")||""}async performUpload(o,n){let t=null,l=!0;console.log("dentro performUpload. Endpoint:",o);try{const s=await fetch(o,{method:"POST",headers:{"X-CSRF-TOKEN":this.csrfToken,Accept:"application/json"},body:n});if(!s.ok){const a=s.headers.get("content-type");a&&a.includes("application/json")?t=await s.json():t={message:"Il server ha restituito una risposta non valida.",details:await s.text(),state:"unknown",errorCode:"unexpected_response",blocking:"blocking"},l=!1}return{error:t,response:s,success:l}}catch(s){return t={message:"Errore durante la richiesta di upload",details:s instanceof Error?s.message:String(s),state:"network",errorCode:"fetch_error",blocking:"blocking"},{error:t,response:!1,success:!1}}}async handleUpload(o){const n=new FormData;return n.append("file",o),this.performUpload("/uploading-files",n)}}class ne extends B{constructor(){super(),this.maxAttempts=3}async handleUpload(o){const n=new FormData;n.append("file",o),n.append("_token",this.csrfToken),n.append("uploadType","egi");let t=0,l=null,s=!1,a=!1;for(;t<this.maxAttempts&&!a;){if(t++,{error:l,response:s,success:a}=await this.performUpload("/upload/egi",n),a)return console.log(`Tentativo ${t} riuscito: ${o.name}`),{error:l,response:s,success:a};console.warn(`Tentativo ${t} fallito: ${(l==null?void 0:l.message)||"Errore sconosciuto"}`),!a&&t<this.maxAttempts&&console.log(`Riprovo il tentativo ${t+1}...`)}return{error:l,response:s,success:a}}}class te extends B{async handleUpload(o){const n=new FormData,t=await this.encryptFile(o);return n.append("file",t),n.append("_token",this.csrfToken),n.append("uploadType","epp"),await this.performUpload("/upload/epp",n)}async performUpload(o,n){let t=null,l=!0;try{const s=await fetch(o,{method:"POST",headers:{"X-CSRF-TOKEN":this.csrfToken,Accept:"application/json"},body:n});if(s.ok){const a=await s.json();(!a.verificationToken||a.verificationToken!=="VALID")&&(l=!1,t={message:"Errore: token di verifica non valido.",errorCode:"invalid_token"})}else{const a=s.headers.get("content-type");a&&a.includes("application/json")?t=await s.json():t={message:"Il server ha restituito una risposta non valida.",details:await s.text(),state:"unknown",errorCode:"unexpected_response",blocking:"blocking"},l=!1}return this.logEPPUploadStatus(l,t),{error:t,response:s,success:l}}catch(s){return t={message:"Errore durante la richiesta di upload",details:s instanceof Error?s.message:String(s),state:"network",errorCode:"fetch_error",blocking:"blocking"},{error:t,response:!1,success:!1}}}async encryptFile(o){const n=await o.arrayBuffer(),t=btoa(String.fromCharCode(...new Uint8Array(n))),l=new Blob([t],{type:o.type});return new File([l],o.name,{type:o.type})}logEPPUploadStatus(o,n){o?console.log("✔ Upload EPP completato con successo."):console.error("❌ Upload EPP fallito:",n)}}class se extends B{async handleUpload(o){const n=new FormData;return n.append("file",o),n.append("_token",this.csrfToken),n.append("uploadType","utility"),await this.performUpload("/upload/utility",n)}}class le{constructor(){this.handlers={egi:new ne,epp:new te,utility:new se,default:new B}}async handleFileUpload(o,n){const t=this.handlers[n]||this.handlers.default;console.log(`Handling file upload with handler: ${t.constructor.name}`);try{const{error:l,response:s,success:a}=await t.handleUpload(o);return{error:l,response:s,success:a}}catch(l){return{error:{message:"Errore durante l'elaborazione dell'upload",details:l instanceof Error?l.message:String(l),state:"handler",errorCode:"handler_error",blocking:"blocking"},response:!1,success:!1}}}}async function ae(){const e=k()||[];if(window.envMode==="local"&&console.log("📤 Uploading files:",e.length),e.length===0){console.warn("⚠️ Nessun file selezionato.");return}N(),f.innerText=window.startingSaving+"...";let o=100/e.length,n=!0,t=0,l=0,s=0,a="";for(const r of e){const d=new FormData;d.append("file",r),d.append("_token",T),d.append("index",s.toString());const C=s===e.length-1;d.append("finished",C?"true":"false"),C&&d.append("iterFailed",t.toString());try{if(window.envMode==="local"&&console.log(`📂 Uploading file: ${r.name}`),$.innerText="",F.checked&&(c(window.startingScan+"...","info"),d.append("someInfectedFiles",l.toString()),d.append("fileName",r.name),await oe(d))){n=!1,t++,l++,Y(r.name),P();continue}const m=re(ie());console.log(`📌 Smistamento su: ${m}`);const E=new le,{error:p,response:j,success:K}=await E.handleFileUpload(r,m);if(K){if(window.envMode==="local"&&console.log(`✅ Upload riuscito: ${r.name}`),D(r.name),j instanceof Response){const G=await j.json();v(G.userMessage||ue(r.name),"success"),ce(s,o)}}else if(p!=null&&p.details){if(console.error("🚨 Errore non JSON:",p.details),a=p.userMessage||"Errore sconosciuto",n=!1,t++,v(a,"error"),p.blocking==="blocking")break}else console.error("🚨 Errore durante l'upload:",p),a=(p==null?void 0:p.userMessage)||"Errore non specificato",n=!1,t++,v(a,"error")}catch(m){n=!1,window.envMode==="local"&&console.error(`❌ Catch in handleUpload: ${m}`);const E=m instanceof Error?{message:m.message,details:m.stack,blocking:"blocking"}:m;if(E.blocking==="blocking"){c(E.userMessage||"Errore critico durante l'upload","error"),t=e.length;break}else a=E.userMessage||"Errore durante l'upload",v(`${a} ${window.of} ${r.name}`,"error"),c(a,"error"),t++,P()}s++}de(n,t)}function re(e){return["egi","epp","utility"].includes(e)?e:"default"}function ie(){const e=window.location.pathname;return e.includes("/upload/egi")?"egi":e.includes("/upload/epp")?"epp":e.includes("/upload/utility")?"utility":"default"}function ce(e,o){y.style.width=`${(e+1)*o}%`,b.innerText=`${Math.round((e+1)*o)}%`}function P(){y.style.width="0",b.innerText=""}function de(e,o){S();const n=k()||[];e&&o===0?I("success"):!e&&o>0&&o<n.length?I("someError"):!e&&o===n.length&&(I("completeFailure"),c(window.completeFailure,"error"))}function ue(e){return window.fileSavedSuccessfullyTemplate.replace(":fileCaricato",e)}window.envMode==="local"&&console.log("Dentro resources/ts/validation.ts");function pe(e){var n;const o=(n=e.name.split(".").pop())==null?void 0:n.toLowerCase();if(!window.allowedExtensions.includes(o)){const t=window.allowedExtensions.join(", "),l=window.allowedExtensionsMessage.replace(":extension",o).replace(":extensions",t);return x.fire({title:window.titleExtensionNotAllowedMessage,text:l,icon:"error",confirmButtonText:"OK"}),{isValid:!1,message:l}}if(!window.allowedMimeTypes.includes(e.type)){const t=window.allowedMimeTypesMessage.replace(":type",e.type).replace(":mimetypes",window.allowedMimeTypesListMessage);return x.fire({title:window.titleFileTypeNotAllowedMessage,text:t,icon:"error",confirmButtonText:"OK"}),{isValid:!1,message:t}}if(e.size>window.maxSize){const t=window.maxSizeMessage.replace(":size",(window.maxSize/1024).toString());return x.fire({title:window.titleFileSizeExceedsMessage,text:t,icon:"error",confirmButtonText:"OK"}),{isValid:!1,message:t}}if(!me(e.name)){const t=window.invalidFileNameMessage.replace(":filename",e.name);return x.fire({title:window.titleInvalidFileNameMessage,text:t,icon:"error",confirmButtonText:"OK"}),{isValid:!1,message:t}}return{isValid:!0}}function me(e){return/^[\w\-. ]+$/.test(e)}async function A(e){f.innerText=window.startingUpload+"...",U.innerHTML="",$.innerText="",100/e.length,N(),_();for(let o=0;o<e.length;o++){const n=e[o];n.name,y.style.width="0%";try{f.innerText=window.loading+"...",z(o,{target:{result:URL.createObjectURL(n)}},e);for(let t=0;t<e.length;t++){const l=e[t].name,s=document.getElementById(`button-${l}`);s&&s.classList.remove("hidden")}Q(),console.log("Preparation completed",window.uploadFiniscedText),F.checked?f.innerText=window.uploadAndScanText:f.innerText=window.uploadFiniscedText}catch(t){let l=t.userMessage;window.envMode==="local"&&(console.log("getPresignedUrl error catch"),console.log("userMessage",l)),v(`${n.name}: ${l}`,"error"),c(l,"error")}}}function fe(){window.Echo.private("upload").listen("FileProcessingUpload",e=>{switch(e.state){case"processSingleFileCompleted":i(e,"success"),c(e.message,"success"),clearInterval(window.scanInterval);break;case"allFileSaved":i(e,"success"),c(e.message,"success"),clearInterval(window.scanInterval);break;case"uploadFailed":i(e,"error"),c(e.message,"error"),clearInterval(window.scanInterval);break;case"finishedWithSameError":i(e,"warning"),c(e.message,"warning"),clearInterval(window.scanInterval),document.getElementById("circle-container").style.display="none";break;case"allFileScannedNotInfected":i(e,"success"),c(e.message,"success"),document.getElementById("circle-container").style.display="none";break;case"allFileScannedSomeInfected":i(e,"warning"),c(e.message,"warning"),document.getElementById("circle-container").style.display="none";break;case"scanndeSameError":i(e,"error"),c(e.message,"error"),document.getElementById("circle-container").style.display="none";break;case"loadingProceedWithSaving":i(e,"error"),c(e.message,"error");break;case"virusScan":i(e,"info"),document.getElementById("circle-container").style.display="block",document.getElementById("status-message").innerText=e.message;break;case"endVirusScan":i(e,"info"),document.getElementById("circle-container").style.display="none",document.getElementById("status-message").innerText=e.message;break;case"validation":i(e,"info"),c(e.message,"info");break;case"tempFileDeleted":i(e,"info");break;case"error":i(e,"error");break;case"infected":i(e,"error"),c(e.message,"error"),clearInterval(window.scanInterval),document.getElementById("circle-loader").style.background="conic-gradient(#ff0000 100%, #ddd 0%)",document.getElementById("scan-progress-text").innerText=window.someInfectedFiles,document.getElementById("circle-container").style.display="none";break;case"info":i(e,"info"),c(e.message,"info");break;default:i(e,"info");break}})}function i(e,o){window.envMode==="local"&&(console.log(`Event Type: ${o}`,e),console.log(`Message: ${e.message}`))}function O(e){if(!e)return!1;for(let o=0;o<e.length;o++){const n=pe(e[o]);if(!n.isValid)return console.error(`File ${e[o].name} did not pass the validation checks: ${n.message}`),!1}return!0}console.log("Dentro file_upload_manager");console.time("handleUploadSetup");document.addEventListener("DOMContentLoaded",function(){window.showEmoji=I,window.handleImage=z,window.removeFile=Z,window.handleFileSelect=o,window.handleUpload=ae,window.handleDrop=n,window.redirectToCollection=e,window.resetButtons=S,window.cancelUpload=t,console.log("allowedExtensions",window.allowedExtensions),console.log("allowedMimeTypes",window.allowedMimeTypes),console.log("envMode",window.envMode),window.envMode==="local"&&(console.log("allowedExtensions",window.allowedExtensions),console.log("allowedMimeTypes",window.allowedMimeTypes),console.log("maxSize",window.maxSize),console.log("Dentro file_upload_manager")),window.envMode==="local"&&console.log("Send email:",window.sendEmail),$.innerText="",fe(),y.style.width="0",b.innerText="",window.envMode==="local"&&(console.log(window.uploadFiniscedText),console.log("allowedExtensionsMessage:",window.allowedExtensionsMessage),console.log("allowedExtensionsListMessage:",window.allowedExtensionsListMessage),console.log("allowedMimeTypesMessage:",window.allowedMimeTypesMessage)),F.addEventListener("click",function(){F.checked?(h.classList.remove("text-red-500"),h.classList.add("text-green-500"),h.innerText=window.enableVirusScanning,M.style.display="block",M.classList.add("text-red-500"),M.innerText=window.virusScanAdvise):(h.classList.remove("text-green-500"),h.classList.add("text-red-500"),h.innerText=window.disableVirusScanning,M.style.display="none")});function e(){window.location.href=window.URLRedirectToCollection}async function o(l){console.log("Handling file select...");const s=k();O(s)&&await A(s)}async function n(l){var a;l.preventDefault();const s=(a=l.dataTransfer)==null?void 0:a.files;s&&O(s)&&await A(s)}async function t(){let l=!1;const s=k();if(s)for(const a of s)a&&a.name&&D(a.name);try{await V()||(l=!0)}catch{l=!0}S(),document.getElementById("collection").innerHTML="",y.style.width="0%",b.innerText="",f.innerText="Upload Status: In attesa...",U.innerHTML=""}console.log("Adding event listeners..."),console.timeEnd("handleUploadSetup")});window.addEventListener("beforeunload",async function(e){let o=!1;try{await V()||(o=!0)}catch{o=!0}o&&(e.preventDefault(),e.returnValue="")});async function V(){const e=document.querySelector('meta[name="csrf-token"]').getAttribute("content");try{if(!(await fetch("/delete-temporary-folder",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":e||""},body:JSON.stringify({folderName:window.temporaryFolder})})).ok)throw new Error("Failed to delete temporary folder");return console.log("Temporary folder deleted successfully"),!0}catch(o){return console.error("Error deleting temporary folder:",o),!1}}
//# sourceMappingURL=file_upload_manager-DovZbd6U.js.map
